---
title: echarts基础vue组件
date: 2021-12-27 10:05:23
permalink: /echarts-base-vue-comp/
id: echarts-base-vue-comp
sticky: 4
categories:
  - 前端
tags:
  - echarts
  - Vue
  - Vue组件
  - 前端
---

# echarts基础vue组件

## 基础组件

组件特点：

1. 自适应容器大小，始终撑满容器
2. 彻底解决因为外层容器不可见导致 echarts 100px 的问题
3. 将 echarts 事件以 vue 事件抛出

### ResizeObserver

可以使用 ResizeObserver 这个 Web Api 来监听容器的大小变化，使用的时候注意下兼容性哦

```vue
<template>
  <div ref="echarts" class="echarts"/>
</template>

<script>
import * as echarts from 'echarts';
import {debounce} from 'lodash';

export default {
 name: 'EchartsDynamicResize',
 props: {
  baseOption: { // 存放一些不变的属性
   type: Object,
   default: () => ({})
  },
  options: { // 存放后续后变化的属性比如dataset
   type: Object,
   default: () => ({})
  }
 },
 data() {
  return {
   chart: null,
   destroyFunc: null
  };
 },
 mounted() {
  this.chart = echarts.init(this.$refs.echarts);
  this.setOption(this.baseOption);
  this.initChartEvent();
  this.fixEchartsSize();
 },
 beforeDestroy() {
  this.chart && this.chart.dispose();
  this.destroyFunc && this.destroyFunc();
 },
 methods: {
  getEchartsInstance() {
   return this.chart;
  },
  setOption(option) {
   this.chart && this.chart.setOption(option);
  },
  initChartEvent() {
   const emitEvents = ['mouseover', 'mouseout', 'click', 'legendselectchanged'];
   emitEvents.forEach(eventName => {
    this.chart.on(eventName, (params) => {
     this.$emit(eventName, params, this.chart);
    });
   });
  },
  fixEchartsSize() {
   const targetNode = this.$refs.echarts;
   const resizeDebounced = debounce(() => {
    this.chart.resize();
   }, 50);
   const resizeObserver = new ResizeObserver(() => {
    resizeDebounced();
   });
   resizeObserver.observe(targetNode);
   this.destroyFunc = () => {
    resizeObserver.disconnect();
   };
  }
 },
 watch: {
  options: {
   handler(val) {
    this.setOption(val);
   },
   deep: true
  }
 }
};
</script>

<style scoped>
.echarts {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
</style>
```

### element-resize-detector

也可以选择这个库来监听元素的大小变化

```vue
<template>
  <div :id="id" ref="echarts" class="my-echarts" :class="className"/>
</template>

<script>
import echarts from 'echarts';
import elementResizeDetector from 'element-resize-detector';
import {debounce} from 'lodash';

export default {
 name: 'wEcharts',
 props: {
  id: {
   type: String,
   default: ''
  },
  className: {
   type: String,
   default: ''
  },
  options: {
   type: Object,
   default: () => ({})
  }
 },
 data() {
  return {
   myChart: null,
   destroyFunc: null
  };
 },
 mounted() {
  this.initChart();
 },
 beforeDestroy() {
  this.destroyFunc && this.destroyFunc();
 },
 methods: {
  getOption() {
   return this.myChart && this.myChart.getOption();
  },
  initChart() {
   this.$nextTick(() => {
    this.myChart = echarts.init(document.getElementById(this.id));
    this.setOption(this.myChart);
    this.initChartEvent();
    this.fixEchartsSize();
   });
  },
  initChartEvent() {
   const emitEvents = ['mouseover', 'mouseout', 'click', 'legendselectchanged'];
   emitEvents.forEach(eventName => {
    this.myChart.on(eventName, (params) => {
     this.$emit(eventName, params, this.myChart);
    });
   });
  },
  setOption(chartInstance) {
   if (chartInstance) {
    chartInstance.setOption(this.options, true);
   }
  },
  fixEchartsSize() {
   if (!this.$refs.echarts) {
    return;
   }
   // element-resize-detector
   const erd = elementResizeDetector();
   const targetNode = this.$refs.echarts;
   const resizeDebounced = debounce(() => {
    this.myChart.resize();
   }, 50);
   erd.listenTo(targetNode, resizeDebounced);
   this.destroyFunc = () => {
    erd.removeListener(targetNode, resizeDebounced);
   };
  }
 },
 watch: {
  options: {
   handler() {
    this.setOption(this.myChart);
   },
   deep: true
  }
 }
};
</script>

<style scoped>
.my-echarts {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
</style>

```

## 高级echarts组件（其实就是带baseOption的高阶组件）

``` vue
<template>
  <echarts
      ref="echarts"
      :base-option="baseOptions"
      :options="options"
      v-on="$listeners"
  ></echarts>
</template>

<script>
import Echarts from '/@/components/echarts';

export default {
 name: 'trend-chart',
 components: {
  Echarts
 },
 props: {
  options: {
   type: Object,
   default: () => ({})
  }
 },
 data() {
  return {
   baseOptions: {
    color: [
     '#1890FF',
     '#00B69B',
     '#8280FF',
     '#FD5454',
     '#FF8E18',
     '#3EADD0'
    ],
    xAxis: {
     type: 'time',
     axisPointer: {
      type: 'shadow'
     },
     axisLabel: {
      textStyle: {
       color: '#8F8F8F',
       fontSize: 12
      }
     },
     axisLine: {
      lineStyle: {
       color: '#E9E9E9'
      }
     },
     axisTick: {
      show: false
     },
     splitLine: {
      show: false
     },
     triggerEvent: true
    },
    yAxis: {
     type: 'value',
     axisLabel: {
      textStyle: {
       color: '#8F8F8F',
       fontSize: 12
      }
     },
     axisTick: {
      show: false
     },
     splitLine: {
      lineStyle: {
       type: 'dashed',
       color: '#E9E9E9'
      }
     }
    },
    series: [
     {
      type: 'line'
     }
    ],
    dataset: {source: []} // 使用数据集
   }
  };
 }
};
</script>

<style scoped>

</style>

```

## vue3 组件更新

1. 去除baseOption，统一使用option，后续监听option变化（建议父组件可以创建shallowRef的option）
2. ts 按需引入
3. 去除overflow: hidden 这样在组件外面也能看到tooltip，有需要自行添加即可
4. 明确emit事件名，有需要自行添加其他事件

### echarts.ts 参考[在 TypeScript 中按需引入](https://echarts.apache.org/handbook/zh/basics/import#%E5%9C%A8-typescript-%E4%B8%AD%E6%8C%89%E9%9C%80%E5%BC%95%E5%85%A5)

后续可以通过这个组件拿到 echarts 和 option 类型，需要增加也在这里增加

```ts
import * as echarts from 'echarts/core';
import {
  BarChart,
  // 系列类型的定义后缀都为 SeriesOption
  BarSeriesOption,
  LineChart,
  LineSeriesOption
} from 'echarts/charts';
import {
  TitleComponent,
  // 组件类型的定义后缀都为 ComponentOption
  TitleComponentOption,
  TooltipComponent,
  TooltipComponentOption,
  GridComponent,
  GridComponentOption,
  // 数据集组件
  DatasetComponent,
  DatasetComponentOption,
  // 内置数据转换器组件 (filter, sort)
  TransformComponent
} from 'echarts/components';
import { LabelLayout, UniversalTransition } from 'echarts/features';
import { CanvasRenderer } from 'echarts/renderers';

// 通过 ComposeOption 来组合出一个只有必须组件和图表的 Option 类型
type ECOption = echarts.ComposeOption<
  | BarSeriesOption
  | LineSeriesOption
  | TitleComponentOption
  | TooltipComponentOption
  | GridComponentOption
  | DatasetComponentOption
>;

// 注册必须的组件
echarts.use([
  TitleComponent,
  TooltipComponent,
  GridComponent,
  DatasetComponent,
  TransformComponent,
  BarChart,
  LineChart,
  LabelLayout,
  UniversalTransition,
  CanvasRenderer
]);

export type { ECOption };

export default echarts;
```

### echarts.vue

```vue
<template>
  <div ref="echartsRef" class="echarts" />
</template>

<script lang="ts" setup>
import { debounce } from 'lodash-es';
import echarts from './echarts';
import type { ECOption } from './echarts';

const props = defineProps<{
  option: ECOption;
}>();

type EventNames = 'mouseover' | 'mouseout' | 'click' | 'legendselectchanged'
interface IEmit {
  (event: 'click', params: any, chart: ReturnType<typeof echarts.init>): void;
  (event: 'resize', params: { width: number, height: number }, chart: ReturnType<typeof echarts.init>): void;
}
const emit = defineEmits<IEmit>();

let chart: ReturnType<typeof echarts.init>;
const echartsRef = ref<HTMLDivElement>();
let destroyFunc: () => void;

const getEchartsInstance = () => chart;
const setOption = (option?: ECOption) => {
  option && chart!.setOption({ ...option });
};
const initChartEvent = () => {
  chart!.on('click' as string, (params) => {
    emit('click', params, chart!);
  });
};
const fixEchartsSize = () => {
  const targetNode = echartsRef.value!;
  const resizeDebounced = debounce(() => {
    chart!.resize();
  }, 50);
  const resizeObserver = new ResizeObserver((targets) => {
    resizeDebounced();
    const [target] = targets;
    emit('resize', { width: target.contentRect.width, height: target.contentRect.height }, chart!);
  });
  resizeObserver.observe(targetNode);
  destroyFunc = () => {
    resizeObserver.disconnect();
  };
};

onMounted(() => {
  chart = echarts.init(echartsRef.value!);
  setOption(props.option);
  initChartEvent();
  fixEchartsSize();
});

onUnmounted(() => {
  chart && chart.dispose();
  destroyFunc && destroyFunc();
});

watch(
  () => props.option,
  (option) => {
    setOption(option);
  },
  { deep: true },
);

defineExpose({
  getEchartsInstance,
});
</script>

<style scoped>
.echarts {
  width: 100%;
  height: 100%;
}
</style>
```

## 一些echarts技巧

### 增量更新

setOption默认会合并option

### legend超出省略

通过这个配置可以看看 echarts 的 format 有什么功能

```js
import {format as echartsFormat} from 'echarts';

const legend = {
 formatter: function (name) {
  return echartsFormat.truncateText(name, 80, undefined, '…', undefined);
 },
 tooltip: {
  show: true
 }
};
```

### echarts 使用数据集 在轴为 time 会无法显示

echarts 使用数据集 在轴为 time 会无法显示，可以在每个 serise 加上 encode 指定维度

```js
const series = {
 encode: {
  x: 'time',
  y: 'dimension_name'
 }
};
```

## bar类型高级组件

组件特点：

1. 基于基础组件开发
2. 将所有基础组件事件抛出
3. axisLabel坐标轴标签太长隐藏，hover坐标轴标签显示tooltip

注意点：

1. 使用Object.assign()合并option并不明智，echarts的setOption默认就会自动合并option

```vue
<template>
  <echarts-base :id="id"
                :options="baseOptions"
                ref="echarts"
                :class-name="className"
                @mouseover="mouserOver"
                @mouseout="mouserOut"
                v-on="$listeners"
  />
</template>

<script>
import echartsBase from '/@/components/echarts';

export default {
 name: 'barChart',
 components: {
  echartsBase
 },
 props: {
  id: {
   type: String,
   required: true,
   default: ''
  },
  className: {
   type: String,
   default: ''
  },
  options: {
   type: Object,
   default: () => ({})
  }
 },
 data() {
  return {
   baseOptions: {
    tooltip: {
     trigger: 'axis',
     axisPointer: {
      type: 'shadow'
     },
     confine: true,
     formatter: undefined
    },
    grid: {
     left: 90,
     bottom: 18,
     right: 30,
     top: 18
    },
    color: [
     // '#1890FF'
     {
      type: 'linear',
      colorStops: [{
       offset: 0, color: '#1890FF' // 0% 处的颜色
      }, {
       offset: 1, color: '#5AC8FF' // 100% 处的颜色
      }]
     },
     {
      type: 'linear',
      colorStops: [{
       offset: 0, color: '#E6E6E6' // 0% 处的颜色
      }, {
       offset: 1, color: '#CCCCCC' // 100% 处的颜色
      }]
     },
     {
      type: 'linear',
      colorStops: [{
       offset: 0, color: '#FFB726' // 0% 处的颜色
      }, {
       offset: 1, color: '#FFD659' // 100% 处的颜色
      }]
     },
     {
      type: 'linear',
      colorStops: [{
       offset: 0, color: '#22D5E6' // 0% 处的颜色
      }, {
       offset: 1, color: '#49BAF2' // 100% 处的颜色
      }]
     },
     {
      type: 'linear',
      colorStops: [{
       offset: 0, color: '#81FBB8' // 0% 处的颜色
      }, {
       offset: 1, color: '#45D885' // 100% 处的颜色
      }]
     },
     {
      type: 'linear',
      colorStops: [{
       offset: 0, color: '#D8795A' // 0% 处的颜色
      }, {
       offset: 1, color: '#F8B28E' // 100% 处的颜色
      }]
     }
    ],
    dataZoom: [
     {
      type: 'inside',
      yAxisIndex: 0
     }
    ],
    xAxis: {
     type: 'value',
     axisLabel: {
      show: false
     },
     axisLine: {
      lineStyle: {
       color: '#D9D9D9'
      }
     },
     axisTick: {
      show: false
     },
     splitLine: {
      lineStyle: {
       type: 'dashed',
       color: '#E8E8E8'
      }
     }
    },
    yAxis: {
     type: 'category',
     axisPointer: {
      type: 'shadow'
     },
     axisLabel: {
      textStyle: {
       color: '#666666',
       fontSize: 12
      },
      formatter: (params) => {
       if (params.length > 5) {
        return params.substring(0, 5) + '...';
       } else {
        return params;
       }
      }
     },
     axisLine: {
      lineStyle: {
       color: '#E8E8E8',
       type: 'dashed'
      }
     },
     axisTick: {
      show: false
     },
     splitLine: {
      show: false
     },
     triggerEvent: true
    },
    series: [{
     type: 'bar',
     cursor: 'default',
     barMaxWidth: 25,
     emphasis: {
      focus: 'series'
     }
    }],
    dataset: {source: []} // 使用数据集
   }
  };
 },
 methods: {
  mouserOver(params, chart) {
   if (params.componentType === 'yAxis') {
    if (params.value.length <= 5) {
     return;
    }
    let offsetX = params.event.offsetX + 10;
    let offsetY = params.event.offsetY + 10;
    chart.setOption({
     tooltip: {
      formatter: () => params.value,
      confine: true,
      alwaysShowContent: true
     }
    });
    chart.dispatchAction({
     type: 'showTip',
     seriesIndex: 0,
     dataIndex: 0,
     position: [offsetX, offsetY]
    });
   } else if (params.componentType === 'series') {
    chart.setOption({
     tooltip: {...this.baseOptions.tooltip}
    });
    chart.dispatchAction({
     type: 'showTip',
     seriesIndex: params.seriesIndex,
     dataIndex: params.dataIndex
    });
   }
  },
  mouserOut(params, chart) {
   if (params.componentType === 'yAxis') {
    this.yLabel = '';
    chart.setOption({tooltip: {
     ...this.baseOptions.tooltip,
     alwaysShowContent: false
    }});
   }
  }
 },
 watch: {
  options: {
   handler: function (val) {
    Object.assign(this.baseOptions, val);
   },
   deep: true
  }
 }
};
</script>

<style scoped>

</style>
```
